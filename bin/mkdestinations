#!/usr/bin/perl -w

use strict;

my ($left, $right, @sources, @dests);
my ($safe);
my (@srcitems, @remoteitems, @localitems);
my $cmd;
my $locale;
my %seen;

# Turn a filepath into something that is safe to use as a filename.
# (A perl guru might be able to do this in one line.)
sub safename {
	my ($name) = @_;
	$_ = $name;

	# the ones that we're really worred about
    s/_/__/g;
    s/:/_C/g;
    s[/][_L]g;
    s/\\/_B/g;
    s/\./_P/g;

	# 0 thru 9 (shifted)
    s/!/_1/g;
    s/\@/_2/g;
    s/#/_3/g;
    s/\$/_4/g;
    s/%/_5/g;
    s/\^/_6/g;
    s/&/_7/g;
    s/\*/_8/g;
    s/\(/_9/g;
    s/\)/_0/g;

	# Others:
    s/\+/_a/g;
    s/`/_b/g;
    s/\]/_c/g;
    s/=/_e/g;
    s/>/_G/g;
    s/</_L/g;
    s/\[/_o/g;
    s/\|/_p/g;
    s/"/_Q/g;
    s/\?/_q/g;
    s/ /_s/g;
    s/;/_S/g;
    s/'/_T/g;
    s/~/_t/g;

	return $_;
}

print "\nall: push-local\n";

my $copycmd;
my $line;

while (defined($line = <>) ) {
	$line =~ s/#.*//;		# toss comments
	chomp $line;
	if ($line =~ s/\\\s*$//) {
		$line .= <>;
        	redo unless eof;
    	}

	$_ = $line;
	next if /^\s*$/;	# skip blank lines

	# Parse the line:
	s/\s+/ /;		# unify whitespace
	($left, $right) = split( /\s+->\s*/, $_, 2 );
	#print "#LEFT=$left\n";
	#print "#RIGHT=$right\n";

	foreach my $src ( split( " ", $left) ) {

		print "\n#Copy SOURCE=$src\n";

		do {

			#push @srcitems, "MP/$src";
			#print "\n";
			#print "MP/$src:\n";
			#print "\tcat $src >\$@\n";

			print "\n";
			print "MS/$src: $src\n";
			print "\t\@if [ ! -r MP/$src ] ; \\\n\tthen \\\n\t\techo CREATING MP/$src ; \\\n\t\tcp $src MP/$src ; \\\n\tfi\n";
			print "\t\@if [ ! -r MS/$src ] ; \\\n\tthen \\\n\t\techo CREATING MS/$src ; \\\n\t\tsed 's/:serial:/'\`cat serial\`'/g' <$src >MS/$src ; \\\n\tfi\n";
			print "\t\@if ! cmp $src MP/$src ; \\\n\tthen \\\n\t\techo UPDATING MP/$src ; \\\n\t\tcp $src MP/$src ; \\\n\t\tsed 's/:serial:/'\`cat serial\`'/g' <$src >MS/$src ; \\\n\tfi\n";
		} unless $seen{"MP/$src"}++;

		foreach my $dst ( split( " ", $right) ) {
			$safe = safename($dst . "--" . $src);

			print "\n#Copy ...DEST=$dst ($safe)\n";

			do {

			if ($dst =~ /:/) {
				$copycmd = "scp";
				push @remoteitems, "DS/$safe";
			} else {
				$copycmd = "cp";
				push @localitems, "DS/$safe";
			}

				print "\n";
				print "DS/$safe: MS/$src\n";
				print "\t$copycmd MS/$src $dst\n";
				print "\tcp MS/$src DS/$safe\n";
			} unless $seen{"DS/$safe"}++;


#			#print "\n#Copy $src to $dst (Done/$safe)\n";
#			die "Can't copy from $src!  Must stay within the directory!" if $src  =~ /\//;
#			die "Can't copy from $src!  No colons allowed!" if $src  =~ /:/;

#$cmd = <<HERE
#Done/$safe: SerialsAdded/$src
#\t\@updatezone $copycmd $src $dst $safe
#\t\@date >Done/$safe
#HERE
#;			print "\n", $cmd unless $seen{"Done/$safe"}++;
#
#$cmd = <<HERE
#SerialsAdded/$src: $src
#\t\@sed 's/:serial:/'\`cat serial\`'/g' <$src >SerialsAdded/$src
#HERE
#;			print "\n", $cmd unless $seen{"SerialsAdded/$src"}++;


		}
	}

}

print "\n";
print "push-all: @srcitems @localitems @remoteitems\n\n";
print "push-local: @srcitems @localitems\n\n";
print "push-remote: @srcitems @remoteitems\n\n";

